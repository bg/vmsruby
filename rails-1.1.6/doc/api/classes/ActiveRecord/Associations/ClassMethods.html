<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Module: ActiveRecord::Associations::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "width=400,height=400,scrollbars=yes" )
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Module</span><br />ActiveRecord::Associations::ClassMethods</td>
  <td align="right">
    <table cellspacing=0 cellpadding=2>
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../../files/vendor/rails/activerecord/lib/active_record/associations_rb.html">vendor/rails/activerecord/lib/active_record/associations.rb</a>
<a href="../../../files/vendor/rails/activerecord/lib/active_record/deprecated_associations_rb.html">vendor/rails/activerecord/lib/active_record/deprecated_associations.rb</a>
        </td>
      </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
Associations are a set of macro-like class methods for tying objects
together through foreign keys. They express relationships like
&quot;Project has one Project Manager&quot; or &quot;Project belongs to a
Portfolio&quot;. Each macro adds a number of methods to the class which are
specialized according to the collection or association symbol and the
options hash. It works much the same way as Ruby&#8217;s own attr* methods.
Example:
</p>
<pre>
  class Project &lt; ActiveRecord::Base
    belongs_to              :portfolio
    has_one                 :project_manager
    has_many                :milestones
    has_and_belongs_to_many :categories
  end
</pre>
<p>
The project class now has the following methods (and more) to ease the
traversal and manipulation of its relationships:
</p>
<ul>
<li><tt>Project#portfolio, Project#portfolio=(portfolio),
Project#portfolio.nil?</tt>

</li>
<li><tt>Project#project_manager, Project#project_manager=(project_manager),
Project#project_manager.nil?,</tt>

</li>
<li><tt>Project#milestones.empty?, Project#milestones.size, Project#milestones,
Project#milestones&lt;&lt;(milestone),</tt>
<tt>Project#milestones.delete(milestone),
Project#milestones.find(milestone_id),
Project#milestones.find_all(conditions),</tt> <tt>Project#milestones.build,
Project#milestones.create</tt>

</li>
<li><tt>Project#categories.empty?, Project#categories.size, Project#categories,
Project#categories&lt;&lt;(category1),</tt>
<tt>Project#categories.delete(category1)</tt>

</li>
</ul>
<h2>Example</h2>
<p>
<img src="../../../files/examples/associations.png">
</p>
<h2>Is it <a href="ClassMethods.html#M000532">belongs_to</a> or has_one?</h2>
<p>
Both express a 1-1 relationship, the difference is mostly where to place
the foreign key, which goes on the table for the class saying <a
href="ClassMethods.html#M000532">belongs_to</a>. Example:
</p>
<pre>
  class Post &lt; ActiveRecord::Base
    has_one :author
  end

  class Author &lt; ActiveRecord::Base
    belongs_to :post
  end
</pre>
<p>
The tables for these classes could look something like:
</p>
<pre>
  CREATE TABLE posts (
    id int(11) NOT NULL auto_increment,
    title varchar default NULL,
    PRIMARY KEY  (id)
  )

  CREATE TABLE authors (
    id int(11) NOT NULL auto_increment,
    post_id int(11) default NULL,
    name varchar default NULL,
    PRIMARY KEY  (id)
  )
</pre>
<h2>Unsaved objects and associations</h2>
<p>
You can manipulate objects and associations before they are saved to the
database, but there is some special behaviour you should be aware of,
mostly involving the saving of associated objects.
</p>
<h3>One-to-one associations</h3>
<ul>
<li>Assigning an object to a <a href="ClassMethods.html#M000531">has_one</a>
association automatically saves that object and the object being replaced
(if there is one), in order to update their primary keys - except if the
parent object is unsaved (new_record? == true).

</li>
<li>If either of these saves fail (due to one of the objects being invalid) the
assignment statement returns false and the assignment is cancelled.

</li>
<li>If you wish to assign an object to a <a
href="ClassMethods.html#M000531">has_one</a> association without saving it,
use the association.build method (documented below).

</li>
<li>Assigning an object to a <a href="ClassMethods.html#M000532">belongs_to</a>
association does not save the object, since the foreign key field belongs
on the parent. It does not save the parent either.

</li>
</ul>
<h3>Collections</h3>
<ul>
<li>Adding an object to a collection (<a
href="ClassMethods.html#M000530">has_many</a> or <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a>) automatically
saves that object, except if the parent object (the owner of the
collection) is not yet stored in the database.

</li>
<li>If saving any of the objects being added to a collection (via push or
similar) fails, then push returns false.

</li>
<li>You can add an object to a collection without automatically saving it by
using the collection.build method (documented below).

</li>
<li>All unsaved (new_record? == true) members of the collection are
automatically saved when the parent is saved.

</li>
</ul>
<h3>Association callbacks</h3>
<p>
Similiar to the normal callbacks that hook into the lifecycle of an Active
Record object, you can also define callbacks that get trigged when you add
an object to or removing an object from a association collection. Example:
</p>
<pre>
  class Project
    has_and_belongs_to_many :developers, :after_add =&gt; :evaluate_velocity

    def evaluate_velocity(developer)
      ...
    end
  end
</pre>
<p>
It&#8217;s possible to stack callbacks by passing them as an array.
Example:
</p>
<pre>
  class Project
    has_and_belongs_to_many :developers, :after_add =&gt; [:evaluate_velocity, Proc.new { |p, d| p.shipping_date = Time.now}]
  end
</pre>
<p>
Possible callbacks are: before_add, after_add, before_remove and
after_remove.
</p>
<p>
Should any of the before_add callbacks throw an exception, the object does
not get added to the collection. Same with the before_remove callbacks, if
an exception is thrown the object doesn&#8217;t get removed.
</p>
<h3>Association extensions</h3>
<p>
The proxy objects that controls the access to associations can be extended
through anonymous modules. This is especially beneficial for adding new
finders, creators, and other factory-type methods that are only used as
part of this association. Example:
</p>
<pre>
  class Account &lt; ActiveRecord::Base
    has_many :people do
      def find_or_create_by_name(name)
        first_name, last_name = name.split(&quot; &quot;, 2)
        find_or_create_by_first_name_and_last_name(first_name, last_name)
      end
    end
  end

  person = Account.find(:first).people.find_or_create_by_name(&quot;David Heinemeier Hansson&quot;)
  person.first_name # =&gt; &quot;David&quot;
  person.last_name  # =&gt; &quot;Heinemeier Hansson&quot;
</pre>
<p>
If you need to share the same extensions between many associations, you can
use a named extension module. Example:
</p>
<pre>
  module FindOrCreateByNameExtension
    def find_or_create_by_name(name)
      first_name, last_name = name.split(&quot; &quot;, 2)
      find_or_create_by_first_name_and_last_name(first_name, last_name)
    end
  end

  class Account &lt; ActiveRecord::Base
    has_many :people, :extend =&gt; FindOrCreateByNameExtension
  end

  class Company &lt; ActiveRecord::Base
    has_many :people, :extend =&gt; FindOrCreateByNameExtension
  end
</pre>
<h3>Association Join Models</h3>
<p>
Has Many associations can be configured with the :through option to use an
explicit join model to retrieve the data. This operates similarly to a
<tt><a href="ClassMethods.html#M000533">has_and_belongs_to_many</a></tt>
association. The advantage is that you&#8217;re able to add validations,
callbacks, and extra attributes on the join model. Consider the following
schema:
</p>
<pre>
  class Author &lt; ActiveRecord::Base
    has_many :authorships
    has_many :books, :through =&gt; :authorships
  end

  class Authorship &lt; ActiveRecord::Base
    belongs_to :author
    belongs_to :book
  end

  @author = Author.find :first
  @author.authorships.collect { |a| a.book } # selects all books that the author's authorships belong to.
  @author.books                              # selects all books by using the Authorship join model
</pre>
<p>
You can also go through a <a href="ClassMethods.html#M000530">has_many</a>
association on the join model:
</p>
<pre>
  class Firm &lt; ActiveRecord::Base
    has_many   :clients
    has_many   :invoices, :through =&gt; :clients
  end

  class Client &lt; ActiveRecord::Base
    belongs_to :firm
    has_many   :invoices
  end

  class Invoice &lt; ActiveRecord::Base
    belongs_to :client
  end

  @firm = Firm.find :first
  @firm.clients.collect { |c| c.invoices }.flatten # select all invoices for all clients of the firm
  @firm.invoices                                   # selects all invoices by going through the Client join model.
</pre>
<h3>Polymorphic Associations</h3>
<p>
Polymorphic associations on models are not restricted on what types of
models they can be associated with. Rather, they specify an interface that
a <a href="ClassMethods.html#M000530">has_many</a> association must adhere
to.
</p>
<pre>
  class Asset &lt; ActiveRecord::Base
    belongs_to :attachable, :polymorphic =&gt; true
  end

  class Post &lt; ActiveRecord::Base
    has_many :assets, :as =&gt; :attachable         # The &lt;tt&gt;:as&lt;/tt&gt; option specifies the polymorphic interface to use.
  end

  @asset.attachable = @post
</pre>
<p>
This works by using a type column in addition to a foreign key to specify
the associated record. In the Asset example, you&#8217;d need an
attachable_id integer column and an attachable_type string column.
</p>
<h2>Caching</h2>
<p>
All of the methods are built on a simple caching principle that will keep
the result of the last query around unless specifically instructed not to.
The cache is even shared across methods to make it even cheaper to use the
macro-added methods without worrying too much about performance at the
first go. Example:
</p>
<pre>
  project.milestones             # fetches milestones from the database
  project.milestones.size        # uses the milestone cache
  project.milestones.empty?      # uses the milestone cache
  project.milestones(true).size  # fetches milestones from the database
  project.milestones             # uses the milestone cache
</pre>
<h2>Eager loading of associations</h2>
<p>
Eager loading is a way to find objects of a certain class and a number of
named associations along with it in a single SQL call. This is one of the
easiest ways of to prevent the dreaded 1+N problem in which fetching 100
posts that each needs to display their author triggers 101 database
queries. Through the use of eager loading, the 101 queries can be reduced
to 1. Example:
</p>
<pre>
  class Post &lt; ActiveRecord::Base
    belongs_to :author
    has_many   :comments
  end
</pre>
<p>
Consider the following loop using the class above:
</p>
<pre>
  for post in Post.find(:all)
    puts &quot;Post:            &quot; + post.title
    puts &quot;Written by:      &quot; + post.author.name
    puts &quot;Last comment on: &quot; + post.comments.first.created_on
  end
</pre>
<p>
To iterate over these one hundred posts, we&#8217;ll generate 201 database
queries. Let&#8217;s first just optimize it for retrieving the author:
</p>
<pre>
  for post in Post.find(:all, :include =&gt; :author)
</pre>
<p>
This references the name of the <a
href="ClassMethods.html#M000532">belongs_to</a> association that also used
the :author symbol, so the find will now weave in a join something like
this: LEFT OUTER JOIN authors ON authors.id = posts.author_id. Doing so
will cut down the number of queries from 201 to 101.
</p>
<p>
We can improve upon the situation further by referencing both associations
in the finder with:
</p>
<pre>
  for post in Post.find(:all, :include =&gt; [ :author, :comments ])
</pre>
<p>
That&#8216;ll add another join along the lines of: LEFT OUTER JOIN comments
ON comments.post_id = posts.id. And we&#8217;ll be down to 1 query. But
that shouldn&#8217;t fool you to think that you can pull out huge amounts
of data with no performance penalty just because you&#8217;ve reduced the
number of queries. The database still needs to send all the data to Active
Record and it still needs to be processed. So it&#8217;s no catch-all for
performance problems, but it&#8217;s a great way to cut down on the number
of queries in a situation as the one described above.
</p>
<p>
Please note that limited eager loading with <a
href="ClassMethods.html#M000530">has_many</a> and <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> associations
is not compatible with describing conditions on these eager tables. This
will work:
</p>
<pre>
  Post.find(:all, :include =&gt; :comments, :conditions =&gt; &quot;posts.title = 'magic forest'&quot;, :limit =&gt; 2)
</pre>
<p>
&#8230;but this will not (and an ArgumentError will be raised):
</p>
<pre>
  Post.find(:all, :include =&gt; :comments, :conditions =&gt; &quot;comments.body like 'Normal%'&quot;, :limit =&gt; 2)
</pre>
<p>
Also have in mind that since the eager loading is pulling from multiple
tables, you&#8217;ll have to disambiguate any column references in both
conditions and orders. So :order =&gt; &quot;posts.id DESC&quot; will work
while :order =&gt; &quot;id DESC&quot; will not. This may require that you
alter the :order and :conditions on the association definitions themselves.
</p>
<p>
It&#8217;s currently not possible to use eager loading on multiple
associations from the same table. Eager loading will not pull additional
attributes on join tables, so &quot;rich associations&quot; with <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> is not a good
fit for eager loading.
</p>
<h2>Table Aliasing</h2>
<p>
ActiveRecord uses table aliasing in the case that a table is referenced
multiple times in a join. If a table is referenced only once, the standard
table name is used. The second time, the table is aliased as
#{reflection_name}_#{parent_table_name}. Indexes are appended for any more
successive uses of the table name.
</p>
<pre>
  Post.find :all, :include =&gt; :comments
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN comments ON ...
  Post.find :all, :include =&gt; :special_comments # STI
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN comments ON ... AND comments.type = 'SpecialComment'
  Post.find :all, :include =&gt; [:comments, :special_comments] # special_comments is the reflection name, posts is the parent table name
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN comments ON ... LEFT OUTER JOIN comments special_comments_posts
</pre>
<p>
Acts as tree example:
</p>
<pre>
  TreeMixin.find :all, :include =&gt; :children
  # =&gt; SELECT ... FROM mixins LEFT OUTER JOIN mixins childrens_mixins ...
  TreeMixin.find :all, :include =&gt; {:children =&gt; :parent} # using cascading eager includes
  # =&gt; SELECT ... FROM mixins LEFT OUTER JOIN mixins childrens_mixins ...
                              LEFT OUTER JOIN parents_mixins ...
  TreeMixin.find :all, :include =&gt; {:children =&gt; {:parent =&gt; :children}}
  # =&gt; SELECT ... FROM mixins LEFT OUTER JOIN mixins childrens_mixins ...
                              LEFT OUTER JOIN parents_mixins ...
</pre>
<p>
LEFT OUTER JOIN mixins childrens_mixins_2
</p>
<p>
Has and Belongs to Many join tables use the same idea, but add a _join
suffix:
</p>
<pre>
  Post.find :all, :include =&gt; :categories
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN categories_posts ... LEFT OUTER JOIN categories ...
  Post.find :all, :include =&gt; {:categories =&gt; :posts}
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN categories_posts ... LEFT OUTER JOIN categories ...
                             LEFT OUTER JOIN categories_posts posts_categories_join LEFT OUTER JOIN posts posts_categories
  Post.find :all, :include =&gt; {:categories =&gt; {:posts =&gt; :categories}}
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN categories_posts ... LEFT OUTER JOIN categories ...
                             LEFT OUTER JOIN categories_posts posts_categories_join LEFT OUTER JOIN posts posts_categories
                             LEFT OUTER JOIN categories_posts categories_posts_join LEFT OUTER JOIN categories categories_posts
</pre>
<p>
If you wish to specify your own custom joins using a :joins option, those
table names will take precedence over the eager associations..
</p>
<pre>
  Post.find :all, :include =&gt; :comments, :joins =&gt; &quot;inner join comments ...&quot;
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN comments_posts ON ... INNER JOIN comments ...
  Post.find :all, :include =&gt; [:comments, :special_comments], :joins =&gt; &quot;inner join comments ...&quot;
  # =&gt; SELECT ... FROM posts LEFT OUTER JOIN comments comments_posts ON ...
                             LEFT OUTER JOIN comments special_comments_posts ...
                             INNER JOIN comments ...
</pre>
<p>
Table aliases are automatically truncated according to the maximum length
of table identifiers according to the specific database.
</p>
<h2>Modules</h2>
<p>
By default, associations will look for objects within the current module
scope. Consider:
</p>
<pre>
  module MyApplication
    module Business
      class Firm &lt; ActiveRecord::Base
         has_many :clients
       end

      class Company &lt; ActiveRecord::Base; end
    end
  end
</pre>
<p>
When Firm#clients is called, it&#8217;ll in turn call
<tt>MyApplication::Business::Company.find(firm.id)</tt>. If you want to
associate with a class in another module scope this can be done by
specifying the complete class name, such as:
</p>
<pre>
  module MyApplication
    module Business
      class Firm &lt; ActiveRecord::Base; end
    end

    module Billing
      class Account &lt; ActiveRecord::Base
        belongs_to :firm, :class_name =&gt; &quot;MyApplication::Business::Firm&quot;
      end
    end
  end
</pre>
<h2>Type safety with ActiveRecord::AssociationTypeMismatch</h2>
<p>
If you attempt to assign an object to an association that doesn&#8217;t
match the inferred or specified <tt>:class_name</tt>, you&#8217;ll get a
ActiveRecord::AssociationTypeMismatch.
</p>
<h2>Options</h2>
<p>
All of the association macros can be specialized through options which
makes more complex cases than the simple and guessable ones possible.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000532">belongs_to</a></li>
  <li><a href="#M000533">has_and_belongs_to_many</a></li>
  <li><a href="#M000530">has_many</a></li>
  <li><a href="#M000531">has_one</a></li>
  </ul>



  <div class="sectiontitle">Classes and Modules</div>
  Class <a href="ClassMethods/JoinDependency.html" class="link">ActiveRecord::Associations::ClassMethods::JoinDependency</a><br />




<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000532"></a><b>belongs_to</b>(association_id, options = {})
  </div>
  <div class="description">
  <p>
Adds the following methods for retrieval and query for a single associated
object that this object holds an id to. <tt>association</tt> is replaced
with the symbol passed as the first argument, so <tt><a
href="ClassMethods.html#M000532">belongs_to</a> :author</tt> would add
among others <tt>author.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - returns the associated object.
Nil is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - assigns the associate object, extracts
the primary key, and sets it as the foreign key.

</li>
<li><tt>association.nil?</tt> - returns true if there is no associated object.

</li>
<li><tt>build_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.

</li>
<li><tt>create_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation).

</li>
</ul>
<p>
Example: A Post class declares <tt><a
href="ClassMethods.html#M000532">belongs_to</a> :author</tt>, which will
add:
</p>
<ul>
<li><tt>Post#author</tt> (similar to <tt>Author.find(author_id)</tt>)

</li>
<li><tt>Post#author=(author)</tt> (similar to <tt>post.author_id =
author.id</tt>)

</li>
<li><tt>Post#author?</tt> (similar to <tt>post.author == some_author</tt>)

</li>
<li><tt>Post#author.nil?</tt>

</li>
<li><tt>Post#build_author</tt> (similar to <tt>post.author = Author.new</tt>)

</li>
<li><tt>Post#create_author</tt> (similar to <tt>post.author = Author.new;
post.author.save; post.author</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000531">has_one</a> :author</tt> will by
default be linked to the <tt>Author</tt> class, but if the real class name
is <tt>Person</tt>, you&#8217;ll have to specify it with this option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;authorized = 1&quot;.

</li>
<li><tt>:order</tt> - specify the order from which the associated object will
be picked at the top. Specified as an &quot;ORDER BY&quot; sql fragment,
such as &quot;last_name, first_name DESC&quot;

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of the associated class in
lower-case and &quot;_id&quot; suffixed. So a <tt>Person</tt> class that
makes a <a href="ClassMethods.html#M000532">belongs_to</a> association to a
<tt>Boss</tt> class will use &quot;boss_id&quot; as the default
foreign_key.

</li>
<li><tt>:counter_cache</tt> - caches the number of belonging objects on the
associate class through use of increment_counter and decrement_counter. The
counter cache is incremented when an object of this class is created and
decremented when it&#8217;s destroyed. This requires that a column named
&quot;#{table_name}_count&quot; (such as comments_count for a belonging
Comment class) is used on the associate class (such as a Post class). You
can also specify a custom counter cache column by given that name instead
of a true/false value to this option (e.g., <tt>:counter_cache =&gt;
:my_custom_counter</tt>.)

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when this object is loaded.

</li>
<li><tt>:polymorphic</tt> - specify this association is a polymorphic
association by passing true.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  belongs_to :firm, :foreign_key =&gt; &quot;client_of&quot;
  belongs_to :author, :class_name =&gt; &quot;Person&quot;, :foreign_key =&gt; &quot;author_id&quot;
  belongs_to :valid_coupon, :class_name =&gt; &quot;Coupon&quot;, :foreign_key =&gt; &quot;coupon_id&quot;,
             :conditions =&gt; 'discounts &gt; #{payments_count}'
  belongs_to :attachable, :polymorphic =&gt; true
</pre>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000532_source')" id="l_M000532_source">show source</a> ]</p>
  <div id="M000532_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activerecord/lib/active_record/associations.rb, line 647</span>
647:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">belongs_to</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span> = {})
648:         <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">create_belongs_to_reflection</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span>)
649:         
650:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:polymorphic</span>]
651:           <span class="ruby-identifier">association_accessor_methods</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">BelongsToPolymorphicAssociation</span>)
652: 
653:           <span class="ruby-identifier">module_eval</span> <span class="ruby-keyword kw">do</span>
654:             <span class="ruby-identifier">before_save</span> <span class="ruby-value str">&quot;association = instance_variable_get(\&quot;@\#{reflection.name}\&quot;)\nif !association.nil?\nif association.new_record?\nassociation.save(true)\nend\n\nif association.updated?\nself[\&quot;\#{reflection.primary_key_name}\&quot;] = association.id\nself[\&quot;\#{reflection.options[:foreign_type]}\&quot;] = association.class.base_class.name.to_s\nend\nend\n&quot;</span>
655:           <span class="ruby-keyword kw">end</span>
656:         <span class="ruby-keyword kw">else</span>
657:           <span class="ruby-identifier">association_accessor_methods</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">BelongsToAssociation</span>)
658:           <span class="ruby-identifier">association_constructor_method</span>(<span class="ruby-identifier">:build</span>,  <span class="ruby-identifier">reflection</span>, <span class="ruby-constant">BelongsToAssociation</span>)
659:           <span class="ruby-identifier">association_constructor_method</span>(<span class="ruby-identifier">:create</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-constant">BelongsToAssociation</span>)
660: 
661:           <span class="ruby-identifier">module_eval</span> <span class="ruby-keyword kw">do</span>
662:             <span class="ruby-identifier">before_save</span> <span class="ruby-value str">&quot;association = instance_variable_get(\&quot;@\#{reflection.name}\&quot;)\nif !association.nil?\nif association.new_record?\nassociation.save(true)\nend\n\nif association.updated?\nself[\&quot;\#{reflection.primary_key_name}\&quot;] = association.id\nend\nend\n&quot;</span>
663:           <span class="ruby-keyword kw">end</span>
664:       
665:           <span class="ruby-comment cmt"># deprecated api</span>
666:           <span class="ruby-identifier">deprecated_has_association_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
667:           <span class="ruby-identifier">deprecated_association_comparison_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">class_name</span>)
668:         <span class="ruby-keyword kw">end</span>
669: 
670:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:counter_cache</span>]
671:           <span class="ruby-identifier">cache_column</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:counter_cache</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span> <span class="ruby-operator">?</span>
672:             <span class="ruby-node">&quot;#{self.to_s.underscore.pluralize}_count&quot;</span> <span class="ruby-operator">:</span>
673:             <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:counter_cache</span>]
674: 
675:           <span class="ruby-identifier">module_eval</span>(
676:             <span class="ruby-node">&quot;after_create '#{reflection.name}.class.increment_counter(\&quot;#{cache_column}\&quot;, #{reflection.primary_key_name})&quot;</span> <span class="ruby-operator">+</span>
677:             <span class="ruby-node">&quot; unless #{reflection.name}.nil?'&quot;</span>
678:           )
679: 
680:           <span class="ruby-identifier">module_eval</span>(
681:             <span class="ruby-node">&quot;before_destroy '#{reflection.name}.class.decrement_counter(\&quot;#{cache_column}\&quot;, #{reflection.primary_key_name})&quot;</span> <span class="ruby-operator">+</span>
682:             <span class="ruby-node">&quot; unless #{reflection.name}.nil?'&quot;</span>
683:           )          
684:         <span class="ruby-keyword kw">end</span>
685:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000533"></a><b>has_and_belongs_to_many</b>(association_id, options = {}, &amp;extension)
  </div>
  <div class="description">
  <p>
Associates two classes via an intermediate join table. Unless the join
table is explicitly specified as an option, it is guessed using the lexical
order of the class names. So a join between Developer and Project will give
the default join table name of &quot;developers_projects&quot; because
&quot;D&quot; outranks &quot;P&quot;.
</p>
<p>
Deprecated: Any additional fields added to the join table will be placed as
attributes when pulling records out through <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> associations.
Records returned from join tables with additional attributes will be marked
as ReadOnly (because we can&#8217;t save changes to the additional
attrbutes). It&#8217;s strongly recommended that you upgrade any
associations with attributes to a real join model (see introduction).
</p>
<p>
Adds the following methods for retrieval and query. <tt>collection</tt> is
replaced with the symbol passed as the first argument, so <tt><a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a>
:categories</tt> would add among others <tt>categories.empty?</tt>.
</p>
<ul>
<li><tt>collection(force_reload = false)</tt> - returns an array of all the
associated objects. An empty array is returned if none is found.

</li>
<li><tt>collection&lt;&lt;(object, &#8230;)</tt> - adds one or more objects to
the collection by creating associations in the join table (collection.push
and collection.concat are aliases to this method).

</li>
<li><tt>collection.push_with_attributes(object, join_attributes)</tt> - adds
one to the collection by creating an association in the join table that
also holds the attributes from <tt>join_attributes</tt> (should be a hash
with the column names as keys). This can be used to have additional
attributes on the join, which will be injected into the associated objects
when they are retrieved through the collection.
(collection.concat_with_attributes is an alias to this method). This method
is now deprecated.

</li>
<li><tt>collection.delete(object, &#8230;)</tt> - removes one or more objects
from the collection by removing their associations from the join table.
This does not destroy the objects.

</li>
<li><tt>collection=objects</tt> - replaces the collections content by deleting
and adding objects as appropriate.

</li>
<li><tt>collection_singular_ids=ids</tt> - replace the collection by the
objects identified by the primary keys in <tt>ids</tt>

</li>
<li><tt>collection.clear</tt> - removes every object from the collection. This
does not destroy the objects.

</li>
<li><tt>collection.empty?</tt> - returns true if there are no associated
objects.

</li>
<li><tt>collection.size</tt> - returns the number of associated objects.

</li>
<li><tt>collection.find(id)</tt> - finds an associated object responding to the
<tt>id</tt> and that meets the condition that it has to be associated with
this object.

</li>
</ul>
<p>
Example: An Developer class declares <tt><a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a>
:projects</tt>, which will add:
</p>
<ul>
<li><tt>Developer#projects</tt>

</li>
<li><tt>Developer#projects&lt;&lt;</tt>

</li>
<li><tt>Developer#projects.push_with_attributes</tt>

</li>
<li><tt>Developer#projects.delete</tt>

</li>
<li><tt>Developer#projects=</tt>

</li>
<li><tt>Developer#project_ids=</tt>

</li>
<li><tt>Developer#projects.clear</tt>

</li>
<li><tt>Developer#projects.empty?</tt>

</li>
<li><tt>Developer#projects.size</tt>

</li>
<li><tt>Developer#projects.find(id)</tt>

</li>
</ul>
<p>
The declaration may include an options hash to specialize the behavior of
the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000533">has_and_belongs_to_many</a>
:projects</tt> will by default be linked to the <tt>Project</tt> class, but
if the real class name is <tt>SuperProject</tt>, you&#8217;ll have to
specify it with this option.

</li>
<li><tt>:join_table</tt> - specify the name of the join table if the default
based on lexical order isn&#8217;t what you want. WARNING: If you&#8217;re
overwriting the table name of either class, the table_name method MUST be
declared underneath any <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> declaration in
order to work.

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> association
will use &quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:association_foreign_key</tt> - specify the association foreign key
used for the association. By default this is guessed to be the name of the
associated class in lower-case and &quot;_id&quot; suffixed. So if the
associated class is <tt>Project</tt>, the <a
href="ClassMethods.html#M000533">has_and_belongs_to_many</a> association
will use &quot;project_id&quot; as the default association foreign_key.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;authorized = 1&quot;.

</li>
<li><tt>:order</tt> - specify the order in which the associated objects are
returned as a &quot;ORDER BY&quot; sql fragment, such as &quot;last_name,
first_name DESC&quot;

</li>
<li><tt>:uniq</tt> - if set to true, duplicate associated objects will be
ignored by accessors and query methods

</li>
<li><tt>:finder_sql</tt> - overwrite the default generated SQL used to fetch
the association with a manual one

</li>
<li><tt>:delete_sql</tt> - overwrite the default generated SQL used to remove
links between the associated classes with a manual one

</li>
<li><tt>:insert_sql</tt> - overwrite the default generated SQL used to add
links between the associated classes with a manual one

</li>
<li><tt>:extend</tt> - anonymous module for extending the proxy, see
&quot;Association extensions&quot;.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when the collection is loaded.

</li>
<li><tt>:group</tt>: An attribute name by which the result should be grouped.
Uses the GROUP BY SQL-clause.

</li>
<li><tt>:limit</tt>: An integer determining the limit on the number of rows
that should be returned.

</li>
<li><tt>:offset</tt>: An integer determining the offset from where the rows
should be fetched. So at 5, it would skip the first 4 rows.

</li>
<li><tt>:select</tt>: By default, this is * as in SELECT * FROM, but can be
changed if you for example want to do a join, but not include the joined
columns.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_and_belongs_to_many :projects
  has_and_belongs_to_many :projects, :include =&gt; [ :milestones, :manager ]
  has_and_belongs_to_many :nations, :class_name =&gt; &quot;Country&quot;
  has_and_belongs_to_many :categories, :join_table =&gt; &quot;prods_cats&quot;
  has_and_belongs_to_many :active_projects, :join_table =&gt; 'developers_projects', :delete_sql =&gt;
  'DELETE FROM developers_projects WHERE active=1 AND developer_id = #{id} AND project_id = #{record.id}'
</pre>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000533_source')" id="l_M000533_source">show source</a> ]</p>
  <div id="M000533_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activerecord/lib/active_record/associations.rb, line 792</span>
792:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_and_belongs_to_many</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">extension</span>)
793:         <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">create_has_and_belongs_to_many_reflection</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">extension</span>)
794:         
795:         <span class="ruby-identifier">add_multiple_associated_save_callbacks</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
796:         <span class="ruby-identifier">collection_accessor_methods</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasAndBelongsToManyAssociation</span>)
797: 
798:         <span class="ruby-comment cmt"># Don't use a before_destroy callback since users' before_destroy</span>
799:         <span class="ruby-comment cmt"># callbacks will be executed after the association is wiped out.</span>
800:         <span class="ruby-identifier">old_method</span> = <span class="ruby-node">&quot;destroy_without_habtm_shim_for_#{reflection.name}&quot;</span>
801:         <span class="ruby-identifier">class_eval</span> <span class="ruby-value str">&quot;alias_method :\#{old_method}, :destroy_without_callbacks\ndef destroy_without_callbacks\n\#{reflection.name}.clear\n\#{old_method}\nend\n&quot;</span>
802: 
803:         <span class="ruby-identifier">add_association_callbacks</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>)
804:         
805:         <span class="ruby-comment cmt"># deprecated api</span>
806:         <span class="ruby-identifier">deprecated_collection_count_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
807:         <span class="ruby-identifier">deprecated_add_association_relation</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
808:         <span class="ruby-identifier">deprecated_remove_association_relation</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
809:         <span class="ruby-identifier">deprecated_has_collection_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
810:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000530"></a><b>has_many</b>(association_id, options = {}, &amp;extension)
  </div>
  <div class="description">
  <p>
Adds the following methods for retrieval and query of collections of
associated objects. <tt>collection</tt> is replaced with the symbol passed
as the first argument, so <tt><a
href="ClassMethods.html#M000530">has_many</a> :clients</tt> would add among
others <tt>clients.empty?</tt>.
</p>
<ul>
<li><tt>collection(force_reload = false)</tt> - returns an array of all the
associated objects. An empty array is returned if none are found.

</li>
<li><tt>collection&lt;&lt;(object, &#8230;)</tt> - adds one or more objects to
the collection by setting their foreign keys to the collection&#8217;s
primary key.

</li>
<li><tt>collection.delete(object, &#8230;)</tt> - removes one or more objects
from the collection by setting their foreign keys to NULL. This will also
destroy the objects if they&#8217;re declared as <a
href="ClassMethods.html#M000532">belongs_to</a> and dependent on this
model.

</li>
<li><tt>collection=objects</tt> - replaces the collections content by deleting
and adding objects as appropriate.

</li>
<li><tt>collection_singular_ids=ids</tt> - replace the collection by the
objects identified by the primary keys in <tt>ids</tt>

</li>
<li><tt>collection.clear</tt> - removes every object from the collection. This
destroys the associated objects if they are <tt>:dependent</tt>, deletes
them directly from the database if they are <tt>:dependent =&gt;
:delete_all</tt>, and sets their foreign keys to NULL otherwise.

</li>
<li><tt>collection.empty?</tt> - returns true if there are no associated
objects.

</li>
<li><tt>collection.size</tt> - returns the number of associated objects.

</li>
<li><tt>collection.find</tt> - finds an associated object according to the same
rules as <a href="../Base.html#M000860">Base.find</a>.

</li>
<li><tt>collection.build(attributes = {})</tt> - returns a new object of the
collection type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.
*Note:* This only works if an associated object already exists, not if
it&#8217;s nil!

</li>
<li><tt>collection.create(attributes = {})</tt> - returns a new object of the
collection type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation). *Note:* This only works if an associated
object already exists, not if it&#8217;s nil!

</li>
</ul>
<p>
Example: A Firm class declares <tt><a
href="ClassMethods.html#M000530">has_many</a> :clients</tt>, which will
add:
</p>
<ul>
<li><tt>Firm#clients</tt> (similar to <tt>Clients.find :all, :conditions =&gt;
&quot;firm_id = #{id}&quot;</tt>)

</li>
<li><tt>Firm#clients&lt;&lt;</tt>

</li>
<li><tt>Firm#clients.delete</tt>

</li>
<li><tt>Firm#clients=</tt>

</li>
<li><tt>Firm#client_ids=</tt>

</li>
<li><tt>Firm#clients.clear</tt>

</li>
<li><tt>Firm#clients.empty?</tt> (similar to <tt>firm.clients.size == 0</tt>)

</li>
<li><tt>Firm#clients.size</tt> (similar to <tt>Client.count &quot;firm_id =
#{id}&quot;</tt>)

</li>
<li><tt>Firm#clients.find</tt> (similar to <tt>Client.find(id, :conditions
=&gt; &quot;firm_id = #{id}&quot;)</tt>)

</li>
<li><tt>Firm#clients.build</tt> (similar to <tt>Client.new(&quot;firm_id&quot;
=&gt; id)</tt>)

</li>
<li><tt>Firm#clients.create</tt> (similar to <tt>c =
Client.new(&quot;firm_id&quot; =&gt; id); c.save; c</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000530">has_many</a> :products</tt> will by
default be linked to the <tt>Product</tt> class, but if the real class name
is <tt>SpecialProduct</tt>, you&#8217;ll have to specify it with this
option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated objects
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;price &gt; 5 AND name LIKE &#8216;B%&#8217;&quot;.

</li>
<li><tt>:order</tt> - specify the order in which the associated objects are
returned as a &quot;ORDER BY&quot; sql fragment, such as &quot;last_name,
first_name DESC&quot;

</li>
<li><tt>:group</tt> - specify the attribute by which the associated objects are
returned as a &quot;GROUP BY&quot; sql fragment, such as
&quot;category&quot;

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000530">has_many</a> association will use
&quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:dependent</tt> - if set to :destroy all the associated objects are
destroyed alongside this object by calling their destroy method. If set to
:delete_all all associated objects are deleted <b>without</b> calling their
destroy method. If set to :nullify all associated objects&#8217; foreign
keys are set to NULL <b>without</b> calling their save callbacks. NOTE:
:dependent =&gt; true is deprecated and has been replaced with :dependent
=&gt; :destroy. May not be set if :exclusively_dependent is also set.

</li>
<li><tt>:exclusively_dependent</tt> - Deprecated; equivalent to :dependent
=&gt; :delete_all. If set to true all the associated object are deleted in
one SQL statement without having their before_destroy callback run. This
should only be used on associations that depend solely on this class and
don&#8217;t need to do any clean-up in before_destroy. The upside is that
it&#8217;s much faster, especially if there&#8217;s a counter_cache
involved. May not be set if :dependent is also set.

</li>
<li><tt>:finder_sql</tt> - specify a complete SQL statement to fetch the
association. This is a good way to go for complex associations that depend
on multiple tables. Note: When this option is used,
<tt>find_in_collection</tt> is <em>not</em> added.

</li>
<li><tt>:counter_sql</tt> - specify a complete SQL statement to fetch the size
of the association. If +:finder_sql+ is specified but +:counter_sql+,
+:counter_sql+ will be generated by replacing SELECT &#8230; FROM with
SELECT COUNT(*) FROM.

</li>
<li><tt>:extend</tt> - specify a named module for extending the proxy, see
&quot;Association extensions&quot;.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when the collection is loaded.

</li>
<li><tt>:group</tt>: An attribute name by which the result should be grouped.
Uses the GROUP BY SQL-clause.

</li>
<li><tt>:limit</tt>: An integer determining the limit on the number of rows
that should be returned.

</li>
<li><tt>:offset</tt>: An integer determining the offset from where the rows
should be fetched. So at 5, it would skip the first 4 rows.

</li>
<li><tt>:select</tt>: By default, this is * as in SELECT * FROM, but can be
changed if you for example want to do a join, but not include the joined
columns.

</li>
<li><tt>:as</tt>: Specifies a polymorphic interface (See <a
href="ClassMethods.html#M000532">belongs_to</a>).

</li>
<li><tt>:through</tt>: Specifies a Join Model to perform the query through.
Options for <tt>:class_name</tt> and <tt>:foreign_key</tt> are ignored, as
the association uses the source reflection. You can only use a
<tt>:through</tt> query through a <tt><a
href="ClassMethods.html#M000532">belongs_to</a></tt> or <tt><a
href="ClassMethods.html#M000530">has_many</a></tt> association.

</li>
<li><tt>:source</tt>: Specifies the source association name used by <tt><a
href="ClassMethods.html#M000530">has_many</a> :through</tt> queries. Only
use it if the name cannot be inferred from the association. <tt><a
href="ClassMethods.html#M000530">has_many</a> :subscribers, :through =&gt;
:subscriptions</tt> will look for either +:subscribers+ or +:subscriber+ on
<tt>Subscription</tt>, unless a +:source+ is given.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_many :comments, :order =&gt; &quot;posted_on&quot;
  has_many :comments, :include =&gt; :author
  has_many :people, :class_name =&gt; &quot;Person&quot;, :conditions =&gt; &quot;deleted = 0&quot;, :order =&gt; &quot;name&quot;
  has_many :tracks, :order =&gt; &quot;position&quot;, :dependent =&gt; :destroy
  has_many :comments, :dependent =&gt; :nullify
  has_many :tags, :as =&gt; :taggable
  has_many :subscribers, :through =&gt; :subscriptions, :source =&gt; :user
  has_many :subscribers, :class_name =&gt; &quot;Person&quot;, :finder_sql =&gt;
      'SELECT DISTINCT people.* ' +
      'FROM people p, post_subscriptions ps ' +
      'WHERE ps.post_id = #{id} AND ps.person_id = p.id ' +
      'ORDER BY p.first_name'
</pre>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000530_source')" id="l_M000530_source">show source</a> ]</p>
  <div id="M000530_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activerecord/lib/active_record/associations.rb, line 519</span>
519:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_many</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">extension</span>)
520:         <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">create_has_many_reflection</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">extension</span>)
521: 
522:         <span class="ruby-identifier">configure_dependency_for_has_many</span>(<span class="ruby-identifier">reflection</span>)
523: 
524:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:through</span>]
525:           <span class="ruby-identifier">collection_reader_method</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasManyThroughAssociation</span>)
526:         <span class="ruby-keyword kw">else</span>
527:           <span class="ruby-identifier">add_multiple_associated_save_callbacks</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
528:           <span class="ruby-identifier">add_association_callbacks</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>)
529:           <span class="ruby-identifier">collection_accessor_methods</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasManyAssociation</span>)
530:         <span class="ruby-keyword kw">end</span>
531: 
532:         <span class="ruby-identifier">add_deprecated_api_for_has_many</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
533:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000531"></a><b>has_one</b>(association_id, options = {})
  </div>
  <div class="description">
  <p>
Adds the following methods for retrieval and query of a single associated
object. <tt>association</tt> is replaced with the symbol passed as the
first argument, so <tt><a href="ClassMethods.html#M000531">has_one</a>
:manager</tt> would add among others <tt>manager.nil?</tt>.
</p>
<ul>
<li><tt>association(force_reload = false)</tt> - returns the associated object.
Nil is returned if none is found.

</li>
<li><tt>association=(associate)</tt> - assigns the associate object, extracts
the primary key, sets it as the foreign key, and saves the associate
object.

</li>
<li><tt>association.nil?</tt> - returns true if there is no associated object.

</li>
<li><tt>build_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key but has not yet been saved.
Note: This ONLY works if an association already exists. It will NOT work if
the association is nil.

</li>
<li><tt>create_association(attributes = {})</tt> - returns a new object of the
associated type that has been instantiated with <tt>attributes</tt> and
linked to this object through a foreign key and that has already been saved
(if it passed the validation).

</li>
</ul>
<p>
Example: An Account class declares <tt><a
href="ClassMethods.html#M000531">has_one</a> :beneficiary</tt>, which will
add:
</p>
<ul>
<li><tt>Account#beneficiary</tt> (similar to <tt>Beneficiary.find(:first,
:conditions =&gt; &quot;account_id = #{id}&quot;)</tt>)

</li>
<li><tt>Account#beneficiary=(beneficiary)</tt> (similar to
<tt>beneficiary.account_id = account.id; beneficiary.save</tt>)

</li>
<li><tt>Account#beneficiary.nil?</tt>

</li>
<li><tt>Account#build_beneficiary</tt> (similar to
<tt>Beneficiary.new(&quot;account_id&quot; =&gt; id)</tt>)

</li>
<li><tt>Account#create_beneficiary</tt> (similar to <tt>b =
Beneficiary.new(&quot;account_id&quot; =&gt; id); b.save; b</tt>)

</li>
</ul>
<p>
The declaration can also include an options hash to specialize the behavior
of the association.
</p>
<p>
Options are:
</p>
<ul>
<li><tt>:class_name</tt> - specify the class name of the association. Use it
only if that name can&#8217;t be inferred from the association name. So
<tt><a href="ClassMethods.html#M000531">has_one</a> :manager</tt> will by
default be linked to the <tt>Manager</tt> class, but if the real class name
is <tt>Person</tt>, you&#8217;ll have to specify it with this option.

</li>
<li><tt>:conditions</tt> - specify the conditions that the associated object
must meet in order to be included as a &quot;WHERE&quot; sql fragment, such
as &quot;rank = 5&quot;.

</li>
<li><tt>:order</tt> - specify the order from which the associated object will
be picked at the top. Specified as

<pre>
 an &quot;ORDER BY&quot; sql fragment, such as &quot;last_name, first_name DESC&quot;
</pre>
</li>
<li><tt>:dependent</tt> - if set to :destroy (or true) all the associated
objects are destroyed when this object is. Also, association is assigned.

</li>
<li><tt>:foreign_key</tt> - specify the foreign key used for the association.
By default this is guessed to be the name of this class in lower-case and
&quot;_id&quot; suffixed. So a <tt>Person</tt> class that makes a <a
href="ClassMethods.html#M000531">has_one</a> association will use
&quot;person_id&quot; as the default foreign_key.

</li>
<li><tt>:include</tt> - specify second-order associations that should be eager
loaded when this object is loaded.

</li>
</ul>
<p>
Option examples:
</p>
<pre>
  has_one :credit_card, :dependent =&gt; :destroy  # destroys the associated credit card
  has_one :credit_card, :dependent =&gt; :nullify  # updates the associated records foriegn key value to null rather than destroying it
  has_one :last_comment, :class_name =&gt; &quot;Comment&quot;, :order =&gt; &quot;posted_on&quot;
  has_one :project_manager, :class_name =&gt; &quot;Person&quot;, :conditions =&gt; &quot;role = 'project_manager'&quot;
</pre>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000531_source')" id="l_M000531_source">show source</a> ]</p>
  <div id="M000531_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/rails/activerecord/lib/active_record/associations.rb, line 577</span>
577:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_one</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span> = {})
578:         <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">create_has_one_reflection</span>(<span class="ruby-identifier">association_id</span>, <span class="ruby-identifier">options</span>)
579: 
580:         <span class="ruby-identifier">module_eval</span> <span class="ruby-keyword kw">do</span>
581:           <span class="ruby-identifier">after_save</span> <span class="ruby-value str">&quot;association = instance_variable_get(\&quot;@\#{reflection.name}\&quot;)\nunless association.nil?\nassociation[\&quot;\#{reflection.primary_key_name}\&quot;] = id\nassociation.save(true)\nend\n&quot;</span>
582:         <span class="ruby-keyword kw">end</span>
583:       
584:         <span class="ruby-identifier">association_accessor_methods</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasOneAssociation</span>)
585:         <span class="ruby-identifier">association_constructor_method</span>(<span class="ruby-identifier">:build</span>,  <span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasOneAssociation</span>)
586:         <span class="ruby-identifier">association_constructor_method</span>(<span class="ruby-identifier">:create</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-constant">HasOneAssociation</span>)
587:         
588:         <span class="ruby-identifier">configure_dependency_for_has_one</span>(<span class="ruby-identifier">reflection</span>)
589: 
590:         <span class="ruby-comment cmt"># deprecated api</span>
591:         <span class="ruby-identifier">deprecated_has_association_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)
592:         <span class="ruby-identifier">deprecated_association_comparison_method</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">class_name</span>)
593:       <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>